<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Analytics Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container { width: 95%; max-width: 900px; margin: 40px auto; padding: 25px; background-color: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .chart-container h3 { text-align: center; margin-top: 0; margin-bottom: 25px; color: #333; font-weight: 600; }
    </style>
</head>
<body>
<div class="dashboard">
    <aside class="sidebar">
        <h2>OpenSlot</h2>
        <nav>
            <ul>
                <li><a href="{{ url_for('index') }}">🏠 Dashboard</a></li>
                <li><a href="{{ url_for('manage_clients') }}">👥 Manage Clients</a></li>
                <li><a href="{{ url_for('add_invoice') }}">➕ Add Invoice</a></li>
                <li><a href="{{ url_for('view_invoices') }}">📄 View Invoices</a></li>
                <li><a href="{{ url_for('analytics_page') }}" class="active">📊 Analytics</a></li>
                <li><a href="{{ url_for('logout') }}">🚪 Logout</a></li>
            </ul>
        </nav>
    </aside>

    <main class="main-content">
        <header class="header">
            <h1>Analytics Dashboard</h1>
            <p>View historical data and automated growth trends based on your payments.</p>
        </header>

        <div class="chart-container">
            <h3>Monthly Income</h3>
            <canvas id="cashFlowChart"></canvas>
        </div>

        <div class="chart-container">
            <h3>Income Trend Prediction</h3>
            <canvas id="predictionChart"></canvas>
        </div>
    </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const commonChartOptions = { };
    fetch('/api/cash_flow_data')
        .then(response => response.json())
        .then(chartData => {
            const ctx = document.getElementById('cashFlowChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Monthly Income ($)',
                        data: chartData.data,
                        fill: true,
                        backgroundColor: 'rgba(76, 130, 247, 0.2)',
                        borderColor: 'rgba(76, 130, 247, 1)',
                        tension: 0.1
                    }]
                },
                options: commonChartOptions
            });
        });
    fetch('/api/predicted_growth_data')
        .then(response => response.json())
        .then(predictionData => {
            if (predictionData.labels.length === 0) {
                const predictionContainer = document.getElementById('predictionChart').parentElement;
                predictionContainer.innerHTML = "<h3>Income Trend Prediction</h3><p style='text-align:center; color:#888;'>Not enough data to make a prediction.</p>";
                return;
            }

            const ctx2 = document.getElementById('predictionChart').getContext('2d');
            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: predictionData.labels,
                    datasets: [
                        { type: 'line', label: 'Trend / Prediction', data: predictionData.predicted_data, borderColor: 'rgba(231, 76, 60, 1)', borderWidth: 2, fill: false, pointRadius: 0, tension: 0.1 },
                        { type: 'bar', label: 'Actual Income', data: predictionData.actual_data, backgroundColor: 'rgba(76, 130, 247, 0.6)' }
                    ]
                },
                options: commonChartOptions
            });
        })
        .catch(error => console.error('Error fetching prediction data:', error));
});
</script>

</body>
</html>